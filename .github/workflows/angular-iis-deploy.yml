name: Deploy-Angular-IIS-Azure

on:
  push:
    branches:
      - 'Feature/**'      # Local deploy
      - 'development'     # After merge → dev deploy (with approval)
      - 'main'            # After merge → prod deploy (with approval)

  workflow_dispatch:
    inputs:
      sha_id:
        description: 'Commit SHA to deploy'
        required: true
        type: string
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - development
          - production

env:
  NODE_VERSION: 20.x
  PROJECT_PATH: .
  ARTIFACT_NAME: HealthClaimsApp

# ============================================================
# 1️⃣ BUILD ANGULAR APP
# ============================================================
jobs:
  build:
    name: Build Angular App
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        working-directory: ${{ env.PROJECT_PATH }}
        run: npm install

      - name: Build Angular
        working-directory: ${{ env.PROJECT_PATH }}
        run: |
          if [[ "${GITHUB_REF}" == refs/heads/Feature/* ]]; then
            CONFIG=local
          elif [[ "${GITHUB_REF}" == refs/heads/development ]]; then
            CONFIG=development
          else
            CONFIG=production
          fi

          echo "Building Angular with config: $CONFIG"
          npx ng build --configuration=$CONFIG

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
          path: dist

# ============================================================
# 2️⃣ LOCAL IIS DEPLOY FOR FEATURE BRANCHES
# ============================================================
  local_deploy:
    name: Deploy Feature Branch to Local IIS
    runs-on: self-hosted
    needs: build
    environment: local
    if: startsWith(github.ref, 'refs/heads/Feature/')
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
          path: deploy_target

      - name: Deploy to Local IIS
        shell: powershell
        run: |
          $target = "F:\Work\Personal\Deployment\AngularApp\local"

          if (-not (Test-Path $target)) {
            New-Item -ItemType Directory -Path $target | Out-Null
          } else {
            Remove-Item "$target\*" -Recurse -Force
          }

          Copy-Item "deploy_target\*" $target -Recurse
          Write-Host "LOCAL deployment completed"

# ============================================================
# 3️⃣ DEPLOYMENT TO DEVELOPMENT (AFTER MERGE)
# ============================================================
  dev_deploy:
    name: Deploy to Development IIS
    runs-on: self-hosted
    needs: build
    environment: development
    if: github.ref == 'refs/heads/development'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
          path: deploy_target

      - name: Deploy to Development
        shell: powershell
        run: |
          $target = "F:\Work\Personal\Deployment\AngularApp\Development"

          if (-not (Test-Path $target)) {
            New-Item -ItemType Directory -Path $target | Out-Null
          } else {
            Remove-Item "$target\*" -Recurse -Force
          }

          Copy-Item "deploy_target\*" $target -Recurse
          Write-Host "DEVELOPMENT deployment done"

# ============================================================
# 4️⃣ DEPLOYMENT TO PRODUCTION (AFTER MERGE)
# ============================================================
  prod_deploy:
    name: Deploy to Production IIS
    runs-on: self-hosted
    needs: build
    environment: production
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
          path: deploy_target

      - name: Deploy to Production
        shell: powershell
        run: |
          $target = "F:\Work\Personal\Deployment\AngularApp\Production"

          if (-not (Test-Path $target)) {
            New-Item -ItemType Directory -Path $target | Out-Null
          } else {
            Remove-Item "$target\*" -Recurse -Force
          }

          Copy-Item "deploy_target\*" $target -Recurse
          Write-Host "PRODUCTION deployment done"
