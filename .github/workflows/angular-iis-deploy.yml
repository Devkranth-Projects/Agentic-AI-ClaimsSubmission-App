name: Angular-IIS-CICD

on:
  push:
    branches:
      - 'Feature/**'
  pull_request:
    branches:
      - 'development'
      - 'main'
  workflow_dispatch:
    inputs:
      sha_id:
        description: 'SHA of the commit to deploy'
        required: true
        type: string
      environment:
        description: 'Target environment (local, development, production)'
        required: true
        type: environment

env:
  NODE_VERSION: 20.x
  PROJECT_PATH: .
  ARTIFACT_NAME: HealthClaimsApp

jobs:
  # ============================================================
  # 1️⃣ Build Angular App
  # ============================================================
  build:
    name: Build Angular App
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Dependencies
        run: npm install
        working-directory: ${{ env.PROJECT_PATH }}

      - name: Build Angular App
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            npx ng build --configuration=local
          elif [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.base_ref }}" = "development" ]; then
            npx ng build --configuration=development
          else
            npx ng build --configuration=production
        working-directory: ${{ env.PROJECT_PATH }}

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
          path: dist

  # ============================================================
  # 2️⃣ Feature Branch → Local IIS
  # ============================================================
  local_deploy:
    name: Deploy Feature Branch to Local IIS
    runs-on: self-hosted
    needs: build
    environment: local
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/Feature/')
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
          path: deploy_target

      - name: Deploy to Local IIS
        shell: powershell
        run: |
          $target = "F:\Work\Personal\Deployment\ClaimsApplication\local"
          if (-not (Test-Path $target)) { New-Item -ItemType Directory -Force -Path $target }
          else { Remove-Item -Path "$target\*" -Recurse -Force }
          Copy-Item "deploy_target\*" $target -Recurse
          Write-Host "LOCAL deployment completed."

  # ============================================================
  # 3️⃣ Trigger Development Deployment
  # ============================================================
  dev_trigger:
    name: Trigger Dev Deployment
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request' && github.base_ref == 'development'
    steps:
      - name: Trigger workflow_dispatch for development
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/${{ github.workflow }}/dispatches \
            -d "{\"ref\":\"development\",\"inputs\":{\"sha_id\":\"${{ github.sha }}\",\"environment\":\"development\"}}"

  # ============================================================
  # 4️⃣ Deploy to Development IIS (After Approval)
  # ============================================================
  dev_deploy:
    name: Deploy to Development IIS
    runs-on: self-hosted
    needs: build
    environment: development
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'development'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.event.inputs.sha_id }}
          path: deploy_target

      - name: Deploy to Development
        shell: powershell
        run: |
          $target = "F:\Work\Personal\Deployment\AngularApp\Development"
          if (-not (Test-Path $target)) { New-Item -ItemType Directory -Force -Path $target }
          else { Remove-Item -Path "$target\*" -Recurse -Force }
          Copy-Item "deploy_target\*" $target -Recurse
          Write-Host "DEVELOPMENT deployment completed."

  # ============================================================
  # 5️⃣ Production Deployment
  # ============================================================
  # prod_deploy:
  #   name: Deploy to Production IIS
  #   runs-on: self-hosted
  #   needs: build
  #   environment: Production
  #   if: github.event_name == 'pull_request' && github.base_ref == 'main'
  #   steps:
  #     - uses: actions/download-artifact@v4
  #       with:
  #         name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
  #         path: deploy_target

  #     - name: Deploy to Production
  #       shell: powershell
  #       run: |
  #         $target = "F:\Work\Personal\Deployment\AngularApp\Production"
  #         if (-not (Test-Path $target)) { New-Item -ItemType Directory -Force -Path $target }
  #         else { Remove-Item -Path "$target\*" -Recurse -Force }
  #         Copy-Item "deploy_target\*" $target -Recurse
  #         Write-Host "PRODUCTION deployment completed."
